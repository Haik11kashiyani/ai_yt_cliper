import argparse
import os
import sys
from video_manager import VideoManager
from advanced_generator import AdvancedVideoGenerator

def main():
    # 1. Parse Arguments (Gets the URL from GitHub Actions)
    parser = argparse.ArgumentParser(description='AI YouTube Shorts Generator')
    parser.add_argument('--url', type=str, help='YouTube Video URL', required=True)
    args = parser.parse_args()

    print(f"üöÄ Starting automation for: {args.url}")

    # 2. Initialize
    vm = VideoManager()
    generator = AdvancedVideoGenerator()

    # 3. Download
    try:
        raw_video_path = vm.download_video(args.url)
        if not raw_video_path:
            print("‚ùå Critical Error: Video failed to download.")
            sys.exit(1)
    except Exception as e:
        print(f"‚ùå Error during download: {e}")
        sys.exit(1)

    # 4. Prepare Output
    output_dir = "generated_shorts"
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
    
    vid_id = os.path.basename(raw_video_path).split('.')[0]
    output_path = os.path.join(output_dir, f"{vid_id}_short.mp4")

    # 5. Generate Short
    # NOTE: Currently set to crop 10s-70s as a test. 
    # Later we will connect 'find_shorts.py' here to get exact viral timestamps.
    print("‚úÇÔ∏è Processing video...")
    result = generator.create_short(
        video_path=raw_video_path,
        start_time=10, 
        end_time=70, 
        output_path=output_path
    )

    if result:
        print(f"‚úÖ SUCCESS! Short created at: {result}")
        # Cleanup
        if os.path.exists(raw_video_path):
            os.remove(raw_video_path)
    else:
        print("‚ùå Failed to create short.")
        sys.exit(1)

if __name__ == "__main__":
    main()
